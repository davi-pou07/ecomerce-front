   /*
            request({
                method: "POST",
                url: "http://localhost:5000/uploadArquivo",
                formData: {loja:loja,file: fs.createReadStream(`./public/upload/${loja}/SIVICAR_DB.ctrl`) }
            },function(err, resp,body) {
                if (err != undefined) {
                    console.log("err")
                    console.log(err)
                    res.json({erro:"Foi identificado um erro"})
                } else {
                    console.log(body)
                    if (body.erro == undefined) {
                        res.json({resp:"Sucesso"})
                    } else {
                        res.json({erro:"Ocorreu um erro durante o processo"})
                    }
                }
            });
            */



            const express = require('express')
const router = express.Router()
const axios = require('axios');

const multer = require('multer')
const fs = require('fs')



const storage = multer.diskStorage({
    destination: function (req, file, cb) {
        var loja = req.body.loja
        console.log(req.body)
        console.log(loja)
        if (!fs.existsSync(`./public/upload`)){
            fs.mkdirSync(`./public/upload`);
        }
        if (!fs.existsSync(`./public/upload/${loja}`)){
            fs.mkdirSync(`./public/upload/${loja}`);
        }
        cb(null, `./public/upload/${loja}`)
    },
    filename: function (req, file, cb) {
        cb(null,file.originalname)
    }
})

const upload = multer({ storage })

//Funções

async function coletarArquivo(loja){

    var resp = await axios.get(`http://localhost:3000/loja/${loja}`)
    console.log("=============resp.data============")
    console.log(resp.data)
    if (resp.data.erro == undefined) {
        return resp.data.resp 
    } else {
        return {erro:resp.data.erro}
    }
}

async function arquivoExistente(loja){
    var dir = `./public/upload/${loja}`
    if (fs.existsSync(`${dir}/SIVICAR_DB.ctrl`)) {
        return true
    } else {
        return false
    }
}


//Rotas

//Rota que o SIVICAR IRA ACESSAR
router.get("/solicitarArquivos/:loja",async(req,res)=>{
    var loja = req.params.loja
    console.log(loja)
    console.log("Iniciando a solicitação")
    //verificar se loja é existente
    var retornoColeta = await coletarArquivo(loja)
    console.log("retornoColeta")
    console.log(retornoColeta)
    if (retornoColeta.erro == undefined) {
        console.log("Não foi apresnetado erros na coleta do arquivo")
        var isExistent = await arquivoExistente(loja)
        if (isExistent) {
            console.log("Arquivo existente")
            res.download(`./public/upload/${loja}/SIVICAR_DB.ctrl`, 'SIVICAR_DB.ctrl')
        } else {
            res.send("Erro, arquivo inexistente")
        }
    } else {
        console.log("Erro")
        res.json({erro:retornoColeta.erro})   
    }
})


router.post("/uploadArquivo",upload.any(),(req,res)=>{
    var file = req.files[0]
    
    console.log(file)
    console.log(req.body)

    if (file != undefined) {
    res.json({resp:"Sucesso"})
    } else {
    res.json({erro:"Arquivo não definido"})
    }
})



module.exports = router